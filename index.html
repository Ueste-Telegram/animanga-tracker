<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AniManga Tracker</title>
    
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(() => null));
        }
    </script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* üé® –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-color: #0f0f23; --card-color: #1a1a2e; --text-color: #ffffff;
            --border-color: #2d3748; --accent-color: #667eea; --secondary-color: #764ba2;
            --success-color: #4caf50; --danger-color: #ff4757;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            padding: 15px; min-height: 100vh; padding-bottom: 80px;
        }
        body.light-theme {
            --bg-color: #f0f2f5; --card-color: #ffffff; --text-color: #1a1a2e;
            --border-color: #ddd; --accent-color: #5856d6;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; padding: 15px; background: var(--card-color); border-radius: 16px; border: 1px solid var(--border-color); }
        .header h1 { font-size: 20px; background: linear-gradient(45deg, var(--accent-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* –¢–∞–±—ã */
        .tabs { display: flex; background: var(--card-color); padding: 4px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); overflow-x: auto; }
        .tab { flex: 1; padding: 8px; background: none; border: none; color: var(--text-color); opacity: 0.6; font-weight: 600; border-radius: 8px; white-space: nowrap; transition: 0.2s; }
        .tab.active { background: var(--accent-color); color: white; opacity: 1; }

        /* –°–µ–∫—Ü–∏–∏ */
        .section { display: none; animation: fade 0.3s; }
        .section.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .item-card { background: var(--card-color); padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 10px; position: relative; }
        .item-header { display: flex; gap: 12px; }
        .cover-wrapper { position: relative; width: 70px; height: 100px; flex-shrink: 0; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; background: #333; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: bold; margin-bottom: 4px; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 13px; opacity: 0.7; margin-bottom: 6px; }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-bg { height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--accent-color); transition: width 0.3s; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: 600; margin-top: 8px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-danger { background: var(--danger-color); color: white; }
        
        /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
        .actions { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; }
        .act-btn { flex: 1; padding: 6px 10px; background: var(--card-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 13px; white-space: nowrap; cursor: pointer; }
        .act-btn:active { opacity: 0.7; }
        
        /* –§–æ—Ä–º—ã */
        .form-control { width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); margin-bottom: 8px; font-size: 16px; }
        textarea.form-control { resize: vertical; min-height: 80px; }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
        .filter-chip { padding: 6px 12px; background: var(--card-color); border: 1px solid var(--border-color); border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .filter-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal { background: var(--card-color); padding: 20px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal h3 { margin-bottom: 15px; text-align: center; }
        .modal-label { font-size: 12px; opacity: 0.7; margin-bottom: 4px; display: block; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notify { position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--card-color); padding: 12px 20px; border-radius: 30px; border: 1px solid var(--accent-color); box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: 0.3s; z-index: 2000; display: flex; gap: 10px; align-items: center; font-weight: 500; }
        .notify.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="notify" class="notify">‚úÖ <span>–ì–æ—Ç–æ–≤–æ</span></div>

    <div class="container">
        <div class="header">
            <h1>üéå AniManga Tracker</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('anime')">üé¨ –ê–Ω–∏–º–µ</button>
            <button class="tab" onclick="switchTab('manga')">üìö –ú–∞–Ω–≥–∞</button>
            <button class="tab" onclick="switchTab('stats')">üìä –ò–Ω—Ñ–æ</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä.</button>
        </div>

        <div id="anime" class="section active">
            <div class="item-card" style="border-style: dashed; border-color: var(--accent-color);">
                <input type="text" id="animeTitle" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ù–∞—Ä—É—Ç–æ)">
                <input type="text" id="animeCover" class="form-control" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É (URL)">
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="animeTotal" class="form-control" placeholder="–í—Å–µ–≥–æ —Å–µ—Ä–∏–π">
                    <select id="animeStatus" class="form-control">
                        <option value="watching">üëÄ –°–º–æ—Ç—Ä—é</option>
                        <option value="planned">üìÖ –ü–ª–∞–Ω—ã</option>
                        <option value="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
                        <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                    </select>
                </div>
                <button class="btn" onclick="addItem('anime')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ê–Ω–∏–º–µ</button>
            </div>
            <div class="filters" id="animeFilters"></div>
            <div id="animeList"></div>
        </div>

        <div id="manga" class="section">
            <div class="item-card" style="border-style: dashed; border-color: var(--accent-color);">
                <input type="text" id="mangaTitle" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–µ—Ä—Å–µ—Ä–∫)">
                <input type="text" id="mangaCover" class="form-control" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É (URL)">
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="mangaTotal" class="form-control" placeholder="–í—Å–µ–≥–æ –≥–ª–∞–≤">
                    <select id="mangaStatus" class="form-control">
                        <option value="reading">üìñ –ß–∏—Ç–∞—é</option>
                        <option value="planned">üìÖ –ü–ª–∞–Ω—ã</option>
                        <option value="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
                        <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                    </select>
                </div>
                <button class="btn" onclick="addItem('manga')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ú–∞–Ω–≥—É</button>
            </div>
            <div class="filters" id="mangaFilters"></div>
            <div id="mangaList"></div>
        </div>

        <div id="stats" class="section">
            <div class="item-card">
                <h3 style="text-align:center; margin-bottom:15px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <canvas id="chart"></canvas>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="item-card">
                <h3>üì≤ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">
                    –ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ:
                    1. –ù–∞–∂–º–∏ "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ".
                    2. –°–æ—Ö—Ä–∞–Ω–∏ —Ç–µ–∫—Å—Ç –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" Telegram.
                    3. –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ.
                </p>
                
                <button class="btn btn-outline" onclick="copyDataToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±—É—Ñ–µ—Ä</button>
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border-color);">
                
                <h3>üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                <textarea id="importArea" class="form-control" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥..."></textarea>
                <button class="btn btn-outline" onclick="importFromText()">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞</button>
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border-color);">
                
                <button class="btn btn-outline" onclick="toggleTheme()">üåì –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
                <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 15px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="editId">
            <input type="hidden" id="editType">
            
            <span class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
            <input type="text" id="editTitle" class="form-control">
            
            <span class="modal-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É</span>
            <input type="text" id="editCover" class="form-control">
            
            <span class="modal-label">–í—Å–µ–≥–æ —Å–µ—Ä–∏–π/–≥–ª–∞–≤</span>
            <input type="number" id="editTotal" class="form-control">
            
            <span class="modal-label">–°—Ç–∞—Ç—É—Å</span>
            <select id="editStatus" class="form-control">
                <option value="watching">–°–º–æ—Ç—Ä—é / –ß–∏—Ç–∞—é</option>
                <option value="planned">–í –ø–ª–∞–Ω–∞—Ö</option>
                <option value="completed">‚úÖ –ì–æ—Ç–æ–≤–æ (–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ)</option>
                <option value="dropped">–ë—Ä–æ—à–µ–Ω–æ</option>
            </select>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="closeEdit()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –¶–≤–µ—Ç–∞ –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
        if (tg.backgroundColor) {
            document.documentElement.style.setProperty('--bg-color', tg.backgroundColor);
            document.documentElement.style.setProperty('--card-color', tg.secondaryBackgroundColor);
            document.documentElement.style.setProperty('--text-color', tg.textColor);
        }

        const DB_KEY = 'animanga_v4_' + (tg.initDataUnsafe?.user?.id || 'local');
        let data = { anime: [], manga: [], settings: { theme: 'dark' } };
        let filters = { anime: 'all', manga: 'all' };

        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        
        function init() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) {
                try {
                    data = JSON.parse(raw);
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –º–∞—Å—Å–∏–≤–æ–≤ (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π)
                    if(!data.anime) data.anime = [];
                    if(!data.manga) data.manga = [];
                } catch(e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
                }
            }
            if (data.settings?.theme === 'light') document.body.classList.add('light-theme');
            renderAll();
        }

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            renderStats();
        }

        function addItem(type) {
            const titleInput = document.getElementById(type + 'Title');
            const coverInput = document.getElementById(type + 'Cover');
            const totalInput = document.getElementById(type + 'Total');
            const statusInput = document.getElementById(type + 'Status');

            const title = titleInput.value.trim();
            const cover = coverInput.value.trim();
            // **–£–°–ò–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ß–ò–°–õ–ê**
            const total = parseInt(totalInput.value) || 0;
            const status = statusInput.value;

            if (!title) return showNotify('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

            // –ê–í–¢–û-–ó–ê–ü–û–õ–ù–ï–ù–ò–ï: –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ì–æ—Ç–æ–≤–æ", —Å—Ç–∞–≤–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å = –≤—Å–µ–≥–æ —Å–µ—Ä–∏–π
            let initialProgress = 0;
            if (status === 'completed') {
                initialProgress = total > 0 ? total : 0;
            }

            data[type].unshift({
                id: Date.now(),
                title, cover, total, status,
                progress: initialProgress
            });

            save();
            renderList(type);
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            titleInput.value = '';
            coverInput.value = '';
            totalInput.value = '';
            showNotify('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
        }

        function updateProgress(type, id, amount) {
            const item = data[type].find(i => i.id === id);
            if (!item) return;

            // **–£–°–ò–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ß–ò–°–ï–õ**
            item.progress = parseInt(item.progress) || 0;
            item.total = parseInt(item.total) || 0;

            let newProgress = item.progress + amount;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ–ª—å–∑—è –º–µ–Ω—å—à–µ 0
            if (newProgress < 0) newProgress = 0;
            
            // –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï (–§–ò–ö–° –û–®–ò–ë–ö–ò –ü–ï–†–ï–ü–û–õ–ù–ï–ù–ò–Ø): –ù–µ–ª—å–∑—è –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞
            if (item.total > 0 && newProgress > item.total) {
                newProgress = item.total;
                showNotify('‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º');
            }

            item.progress = newProgress;

            // –ê–≤—Ç–æ-—Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–ì–æ—Ç–æ–≤–æ", –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞
            if (item.total > 0 && item.progress >= item.total && item.status !== 'completed') {
                item.status = 'completed';
                showNotify('üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!');
            }

            save();
            renderList(type);
        }

        // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ---
        
        function openEdit(type, id) {
            const item = data[type].find(i => i.id === id);
            if (!item) return;

            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editTitle').value = item.title;
            // **–§–ò–ö–° –û–ë–õ–û–ñ–ö–ò**: –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ
            document.getElementById('editCover').value = item.cover || '';
            document.getElementById('editTotal').value = item.total || '';
            
            const select = document.getElementById('editStatus');
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            if (type === 'anime' && item.status === 'watching') select.value = 'watching';
            else if (type === 'manga' && item.status === 'reading') select.value = 'watching'; // –ß–∏—Ç–∞—é = –°–º–æ—Ç—Ä—é –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –æ–∫–Ω–µ
            else select.value = item.status;

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEdit() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('editId').value);
            const type = document.getElementById('editType').value;
            const item = data[type].find(i => i.id === id);

            if (item) {
                item.title = document.getElementById('editTitle').value;
                // **–§–ò–ö–° –û–ë–õ–û–ñ–ö–ò**: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–µ
                item.cover = document.getElementById('editCover').value;
                
                // **–£–°–ò–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ß–ò–°–õ–ê**
                const newTotal = parseInt(document.getElementById('editTotal').value) || 0;
                item.total = newTotal;
                
                let rawStatus = document.getElementById('editStatus').value;
                if (type === 'manga' && rawStatus === 'watching') rawStatus = 'reading';
                item.status = rawStatus;

                // –§–ò–ö–° "–ì–û–¢–û–í–û = –í–°–ï –°–ï–†–ò–ò": –ï—Å–ª–∏ —Å–º–µ–Ω–∏–ª–∏ –Ω–∞ "–ì–æ—Ç–æ–≤–æ" -> –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ –º–∞–∫—Å–∏–º—É–º–∞
                if (item.status === 'completed' && item.total > 0) {
                    item.progress = item.total;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ —É–º–µ–Ω—å—à–∏–ª–∏ –æ–±—â–µ–µ –∫–æ–ª-–≤–æ —Å–µ—Ä–∏–π)
                if (item.total > 0 && item.progress > item.total) {
                    item.progress = item.total;
                }

                save();
                renderList(type);
                closeEdit();
                showNotify('üíæ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            }
        }

        function deleteItem(type, id) {
            if (confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ?')) {
                data[type] = data[type].filter(i => i.id !== id);
                save();
                renderList(type);
                showNotify('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
            }
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì ---

        function renderAll() {
            renderFilters('anime');
            renderFilters('manga');
            renderList('anime');
            renderList('manga');
            renderStats();
        }

        function renderFilters(type) {
            const statuses = ['all', 'watching', 'reading', 'planned', 'completed', 'dropped'];
            const valid = statuses.filter(s => {
                if (type === 'anime' && s === 'reading') return false;
                if (type === 'manga' && s === 'watching') return false;
                return true;
            });

            const container = document.getElementById(type + 'Filters');
            container.innerHTML = valid.map(s => {
                const active = filters[type] === s ? 'active' : '';
                const label = getStatusLabel(s);
                return `<button class="filter-chip ${active}" onclick="setFilter('${type}', '${s}')">${label}</button>`;
            }).join('');
        }

        function setFilter(type, s) {
            filters[type] = s;
            renderFilters(type);
            renderList(type);
        }

        function renderList(type) {
            const container = document.getElementById(type + 'List');
            const list = data[type].filter(i => filters[type] === 'all' || i.status === filters[type]);

            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:30px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            container.innerHTML = list.map(item => {
                // **–£–°–ò–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ß–ò–°–ï–õ**
                const total = parseInt(item.total) || 0;
                const progress = parseInt(item.progress) || 0;
                
                const percent = total > 0 ? Math.min((progress / total) * 100, 100) : 0;
                const statusLabel = getStatusLabel(item.status);
                
                let coverHtml = `<div class="cover-wrapper" style="background:#333; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px;">?</div>`;
                if (item.cover) {
                    coverHtml = `<div class="cover-wrapper"><img src="${item.cover}" class="cover-img" onerror="this.style.display='none'"></div>`;
                }

                return `
                <div class="item-card">
                    <div class="item-header">
                        ${coverHtml}
                        <div class="item-info">
                            <div class="item-title">${item.title}</div>
                            <div class="item-meta">${statusLabel} ‚Ä¢ ${progress} / ${total || '?'}</div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div class="actions">
                                <button class="act-btn" onclick="updateProgress('${type}', ${item.id}, 1)">+1</button>
                                <button class="act-btn" onclick="updateProgress('${type}', ${item.id}, 5)">+5</button>
                                <button class="act-btn" onclick="openEdit('${type}', ${item.id})">‚úèÔ∏è</button>
                                <button class="act-btn" style="color:var(--danger-color); border-color:var(--danger-color)" onclick="deleteItem('${type}', ${item.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            const ctx = document.getElementById('chart').getContext('2d');
            let s = { w: 0, p: 0, c: 0, d: 0 };
            
            [...data.anime, ...data.manga].forEach(i => {
                if (i.status.includes('watching') || i.status.includes('reading')) s.w++;
                else if (i.status === 'planned') s.p++;
                else if (i.status === 'completed') s.c++;
                else if (i.status === 'dropped') s.d++;
            });

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–ü–ª–∞–Ω—ã', '–ì–æ—Ç–æ–≤–æ', '–ë—Ä–æ—à–µ–Ω–æ'],
                    datasets: [{
                        data: [s.w, s.p, s.c, s.d],
                        backgroundColor: ['#667eea', '#f6e58d', '#4caf50', '#ff4757'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#888', boxWidth: 12, padding: 20 } } 
                    } 
                }
            });
        }

        // --- –£–¢–ò–õ–ò–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---

        function getStatusLabel(s) {
            const map = { 'all': '–í—Å–µ', 'watching': '–°–º–æ—Ç—Ä—é', 'reading': '–ß–∏—Ç–∞—é', 'planned': '–ü–ª–∞–Ω—ã', 'completed': '–ì–æ—Ç–æ–≤–æ', 'dropped': '–ë—Ä–æ—à–µ–Ω–æ' };
            return map[s] || s;
        }

        function switchTab(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showNotify(msg) {
            const n = document.getElementById('notify');
            n.innerHTML = msg;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 2500);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            data.settings = data.settings || {};
            data.settings.theme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            save();
        }

        function clearAll() {
            if (confirm('‚ö†Ô∏è –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–ï–°–¨ –≤–∞—à —Å–ø–∏—Å–æ–∫ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                localStorage.removeItem(DB_KEY);
                data = { anime: [], manga: [], settings: { theme: 'dark' } };
                renderAll();
                showNotify('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
            }
        }

        // --- –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï (–¢–ï–ö–°–¢–û–í–û–ï) ---

        function copyDataToClipboard() {
            const json = JSON.stringify(data);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(json).then(() => {
                    showNotify('üìã –î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
                }).catch(() => {
                    // –§–æ–ª–±—ç–∫, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é.');
                    document.getElementById('importArea').value = json;
                });
            } else {
                 document.getElementById('importArea').value = json;
                 showNotify('üëá –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –Ω–∏–∂–µ');
            }
        }

        function importFromText() {
            const raw = document.getElementById('importArea').value.trim();
            if (!raw) return showNotify('‚ùå –ü–æ–ª–µ –ø—É—Å—Ç–æ–µ');

            try {
                const parsed = JSON.parse(raw);
                // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                if (Array.isArray(parsed.anime) || Array.isArray(parsed.manga)) {
                    data = parsed;
                    save();
                    renderAll();
                    showNotify('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
                    document.getElementById('importArea').value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
                } else {
                    alert('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç.');
            }
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
