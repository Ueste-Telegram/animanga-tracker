<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AniManga Tracker</title>
    
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(() => null));
        }
    </script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* üé® –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-color: #0f0f23; --card-color: #1a1a2e; --text-color: #ffffff;
            --border-color: #2d3748; --accent-color: #667eea; --secondary-color: #764ba2;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            padding: 15px; min-height: 100vh; padding-bottom: 80px;
        }
        body.light-theme {
            --bg-color: #f0f2f5; --card-color: #ffffff; --text-color: #1a1a2e;
            --border-color: #ddd; --accent-color: #5856d6;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; padding: 15px; background: var(--card-color); border-radius: 16px; border: 1px solid var(--border-color); }
        .header h1 { font-size: 20px; background: linear-gradient(45deg, var(--accent-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* –¢–∞–±—ã */
        .tabs { display: flex; background: var(--card-color); padding: 4px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); overflow-x: auto; }
        .tab { flex: 1; padding: 8px; background: none; border: none; color: var(--text-color); opacity: 0.6; font-weight: 600; border-radius: 8px; white-space: nowrap; transition: 0.2s; }
        .tab.active { background: var(--accent-color); color: white; opacity: 1; }

        /* –°–µ–∫—Ü–∏–∏ */
        .section { display: none; animation: fade 0.3s; }
        .section.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .item-card { background: var(--card-color); padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 10px; position: relative; }
        .item-header { display: flex; gap: 12px; }
        .cover-img { width: 70px; height: 100px; object-fit: cover; border-radius: 6px; background: #333; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: bold; margin-bottom: 4px; font-size: 16px; }
        .item-meta { font-size: 13px; opacity: 0.7; margin-bottom: 6px; }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-bg { height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--accent-color); transition: width 0.3s; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: 600; margin-top: 8px; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-danger { background: #ff4757; color: white; }
        
        /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
        .actions { display: flex; gap: 6px; margin-top: 8px; overflow-x: auto; }
        .act-btn { padding: 5px 10px; background: var(--card-color); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-color); font-size: 12px; white-space: nowrap; }
        
        /* –§–æ—Ä–º—ã */
        .form-control { width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); margin-bottom: 8px; }
        
        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
        .filter-chip { padding: 6px 12px; background: var(--card-color); border: 1px solid var(--border-color); border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .filter-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: var(--card-color); padding: 20px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
        .modal h3 { margin-bottom: 15px; text-align: center; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notify { position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--card-color); padding: 12px 20px; border-radius: 30px; border: 1px solid var(--accent-color); box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: 0.3s; z-index: 2000; display: flex; gap: 10px; align-items: center; }
        .notify.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="notify" class="notify">‚úÖ <span>–ì–æ—Ç–æ–≤–æ</span></div>

    <div class="container">
        <div class="header">
            <h1>üéå AniManga Tracker</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('anime')">üé¨ –ê–Ω–∏–º–µ</button>
            <button class="tab" onclick="switchTab('manga')">üìö –ú–∞–Ω–≥–∞</button>
            <button class="tab" onclick="switchTab('stats')">üìä –ò–Ω—Ñ–æ</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div id="anime" class="section active">
            <div class="item-card" style="border-style: dashed;">
                <input type="text" id="animeTitle" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ù–∞—Ä—É—Ç–æ)">
                <input type="text" id="animeCover" class="form-control" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="animeTotal" class="form-control" placeholder="–í—Å–µ–≥–æ —Å–µ—Ä–∏–π (12)">
                    <select id="animeStatus" class="form-control">
                        <option value="watching">üëÄ –°–º–æ—Ç—Ä—é</option>
                        <option value="planned">üìÖ –ü–ª–∞–Ω—ã</option>
                        <option value="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
                        <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                    </select>
                </div>
                <button class="btn" onclick="addItem('anime')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ê–Ω–∏–º–µ</button>
            </div>
            <div class="filters" id="animeFilters"></div>
            <div id="animeList"></div>
        </div>

        <div id="manga" class="section">
            <div class="item-card" style="border-style: dashed;">
                <input type="text" id="mangaTitle" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ë–µ—Ä—Å–µ—Ä–∫)">
                <input type="text" id="mangaCover" class="form-control" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="mangaTotal" class="form-control" placeholder="–í—Å–µ–≥–æ –≥–ª–∞–≤ (100)">
                    <select id="mangaStatus" class="form-control">
                        <option value="reading">üìñ –ß–∏—Ç–∞—é</option>
                        <option value="planned">üìÖ –ü–ª–∞–Ω—ã</option>
                        <option value="completed">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
                        <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                    </select>
                </div>
                <button class="btn" onclick="addItem('manga')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ú–∞–Ω–≥—É</button>
            </div>
            <div class="filters" id="mangaFilters"></div>
            <div id="mangaList"></div>
        </div>

        <div id="stats" class="section">
            <div class="item-card">
                <canvas id="chart"></canvas>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="item-card">
                <h3>–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <p style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">–ï—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å".</p>
                
                <button class="btn btn-outline" onclick="copyDataToClipboard()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–ù–∞–¥–µ–∂–Ω–æ)</button>
                <button class="btn btn-outline" onclick="exportFile()">üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (–î–ª—è –ü–ö)</button>
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border-color);">
                
                <h3>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
                <input type="file" id="importFile" hidden onchange="importFile(this)">
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border-color);">
                
                <button class="btn btn-outline" onclick="toggleTheme()">üåì –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
                <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 15px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="editId">
            <input type="hidden" id="editType">
            
            <label style="font-size: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="editTitle" class="form-control">
            
            <label style="font-size: 12px;">–û–±–ª–æ–∂–∫–∞ (URL)</label>
            <input type="text" id="editCover" class="form-control">
            
            <label style="font-size: 12px;">–í—Å–µ–≥–æ —Å–µ—Ä–∏–π/–≥–ª–∞–≤</label>
            <input type="number" id="editTotal" class="form-control">
            
            <label style="font-size: 12px;">–°—Ç–∞—Ç—É—Å</label>
            <select id="editStatus" class="form-control">
                <option value="watching">–°–º–æ—Ç—Ä—é / –ß–∏—Ç–∞—é</option>
                <option value="planned">–í –ø–ª–∞–Ω–∞—Ö</option>
                <option value="completed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ / –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</option>
                <option value="dropped">–ë—Ä–æ—à–µ–Ω–æ</option>
            </select>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="closeEdit()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –¶–≤–µ—Ç–∞ –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º
        if (tg.backgroundColor) {
            document.documentElement.style.setProperty('--bg-color', tg.backgroundColor);
            document.documentElement.style.setProperty('--card-color', tg.secondaryBackgroundColor);
            document.documentElement.style.setProperty('--text-color', tg.textColor);
        }

        const DB_KEY = 'animanga_v3_' + (tg.initDataUnsafe?.user?.id || 'local');
        let data = { anime: [], manga: [], settings: { theme: 'dark' } };
        let filters = { anime: 'all', manga: 'all' };

        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        
        function init() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) data = JSON.parse(raw);
            if (data.settings.theme === 'light') document.body.classList.add('light-theme');
            renderAll();
        }

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            renderStats();
        }

        function addItem(type) {
            const title = document.getElementById(type + 'Title').value.trim();
            const cover = document.getElementById(type + 'Cover').value.trim();
            const total = parseInt(document.getElementById(type + 'Total').value) || 0;
            const status = document.getElementById(type + 'Status').value;

            if (!title) return showNotify('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

            // –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–ì–æ—Ç–æ–≤–æ"
            let initialProgress = 0;
            if (status === 'completed' && total > 0) initialProgress = total;

            data[type].unshift({
                id: Date.now(),
                title, cover, total, status,
                progress: initialProgress,
                rating: 0
            });

            save();
            renderList(type);
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById(type + 'Title').value = '';
            document.getElementById(type + 'Cover').value = '';
            document.getElementById(type + 'Total').value = '';
            showNotify('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
        }

        function updateProgress(type, id, amount) {
            const item = data[type].find(i => i.id === id);
            if (!item) return;

            let newProgress = item.progress + amount;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ–ª—å–∑—è –º–µ–Ω—å—à–µ 0
            if (newProgress < 0) newProgress = 0;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ–ª—å–∑—è –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞ (–µ—Å–ª–∏ –º–∞–∫—Å–∏–º—É–º –∑–∞–¥–∞–Ω)
            if (item.total > 0 && newProgress > item.total) {
                newProgress = item.total;
                showNotify('‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º');
            }

            item.progress = newProgress;

            // –ê–≤—Ç–æ-—Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ"
            if (item.total > 0 && item.progress >= item.total && item.status !== 'completed') {
                item.status = 'completed';
                showNotify('üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!');
            }

            save();
            renderList(type);
        }

        // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ---
        
        function openEdit(type, id) {
            const item = data[type].find(i => i.id === id);
            if (!item) return;

            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editCover').value = item.cover || '';
            document.getElementById('editTotal').value = item.total || '';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–ª–µ–∫—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
            const select = document.getElementById('editStatus');
            // –•–∞–∫ –¥–ª—è "reading/watching" —Ç–∞–∫ –∫–∞–∫ –≤ select –æ–Ω–∏ —Ä–∞–∑–Ω—ã–µ
            if (type === 'anime' && item.status === 'watching') select.value = 'watching';
            else if (type === 'manga' && item.status === 'reading') select.value = 'watching'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º watching –∫–∞–∫ value –≤ –º–æ–¥–∞–ª–∫–µ
            else select.value = item.status;

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEdit() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('editId').value);
            const type = document.getElementById('editType').value;
            const item = data[type].find(i => i.id === id);

            if (item) {
                item.title = document.getElementById('editTitle').value;
                item.cover = document.getElementById('editCover').value;
                item.total = parseInt(document.getElementById('editTotal').value) || 0;
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                let rawStatus = document.getElementById('editStatus').value;
                if (type === 'manga' && rawStatus === 'watching') rawStatus = 'reading';
                item.status = rawStatus;

                // –ï—Å–ª–∏ —Å–º–µ–Ω–∏–ª–∏ –Ω–∞ "–ì–æ—Ç–æ–≤–æ" - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (item.status === 'completed' && item.total > 0) {
                    item.progress = item.total;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (item.total > 0 && item.progress > item.total) {
                    item.progress = item.total;
                }

                save();
                renderList(type);
                closeEdit();
                showNotify('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }
        }

        function deleteItem(type, id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                data[type] = data[type].filter(i => i.id !== id);
                save();
                renderList(type);
            }
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì ---

        function renderAll() {
            renderFilters('anime');
            renderFilters('manga');
            renderList('anime');
            renderList('manga');
            renderStats();
        }

        function renderFilters(type) {
            const statuses = ['all', 'watching', 'reading', 'planned', 'completed', 'dropped'];
            const valid = statuses.filter(s => {
                if (type === 'anime' && s === 'reading') return false;
                if (type === 'manga' && s === 'watching') return false;
                return true;
            });

            const container = document.getElementById(type + 'Filters');
            container.innerHTML = valid.map(s => {
                const active = filters[type] === s ? 'active' : '';
                const label = getStatusLabel(s);
                return `<button class="filter-chip ${active}" onclick="setFilter('${type}', '${s}')">${label}</button>`;
            }).join('');
        }

        function setFilter(type, s) {
            filters[type] = s;
            renderFilters(type);
            renderList(type);
        }

        function renderList(type) {
            const container = document.getElementById(type + 'List');
            const list = data[type].filter(i => filters[type] === 'all' || i.status === filters[type]);

            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">–ü—É—Å—Ç–æ</div>';
                return;
            }

            container.innerHTML = list.map(item => {
                const percent = item.total > 0 ? Math.min((item.progress / item.total) * 100, 100) : 0;
                const statusLabel = getStatusLabel(item.status);
                const coverHtml = item.cover ? `<img src="${item.cover}" class="cover-img" onerror="this.style.display='none'">` : '';

                return `
                <div class="item-card">
                    <div class="item-header">
                        ${coverHtml}
                        <div class="item-info">
                            <div class="item-title">${item.title}</div>
                            <div class="item-meta">${statusLabel} ‚Ä¢ ${item.progress} / ${item.total || '?'}</div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div class="actions">
                                <button class="act-btn" onclick="updateProgress('${type}', ${item.id}, 1)">+1</button>
                                <button class="act-btn" onclick="updateProgress('${type}', ${item.id}, 5)">+5</button>
                                <button class="act-btn" onclick="openEdit('${type}', ${item.id})">‚úèÔ∏è –†–µ–¥.</button>
                                <button class="act-btn" style="color:#ff4757; border-color:#ff4757" onclick="deleteItem('${type}', ${item.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            const ctx = document.getElementById('chart').getContext('2d');
            let s = { w: 0, p: 0, c: 0, d: 0 };
            
            [...data.anime, ...data.manga].forEach(i => {
                if (i.status.includes('watching') || i.status.includes('reading')) s.w++;
                else if (i.status === 'planned') s.p++;
                else if (i.status === 'completed') s.c++;
                else if (i.status === 'dropped') s.d++;
            });

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–°–º–æ—Ç—Ä—é', '–ü–ª–∞–Ω—ã', '–ì–æ—Ç–æ–≤–æ', '–ë—Ä–æ—à–µ–Ω–æ'],
                    datasets: [{
                        data: [s.w, s.p, s.c, s.d],
                        backgroundColor: ['#667eea', '#f6e58d', '#4caf50', '#ff4757'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: '#888', boxWidth: 12 } } } }
            });
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---

        function getStatusLabel(s) {
            const map = { 'all': '–í—Å–µ', 'watching': '–°–º–æ—Ç—Ä—é', 'reading': '–ß–∏—Ç–∞—é', 'planned': '–ü–ª–∞–Ω—ã', 'completed': '–ì–æ—Ç–æ–≤–æ', 'dropped': '–ë—Ä–æ—à–µ–Ω–æ' };
            return map[s] || s;
        }

        function switchTab(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showNotify(msg) {
            const n = document.getElementById('notify');
            n.innerHTML = msg;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 2000);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            data.settings.theme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            save();
        }

        function clearAll() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ---

        function copyDataToClipboard() {
            const json = JSON.stringify(data);
            navigator.clipboard.writeText(json).then(() => {
                showNotify('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!');
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ:\n\n' + json);
            });
        }

        function exportFile() {
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'animanga_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    save();
                    renderAll();
                    showNotify('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞');
                }
            };
            reader.readAsText(file);
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
