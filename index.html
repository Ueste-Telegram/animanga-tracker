<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AniManga Tracker</title>
    
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Track your anime and manga progress">
    
    <link rel="manifest" href="manifest.json">
    <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è —Ä–∞–±–æ—Ç—ã –æ—Ñ—Ñ–ª–∞–π–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker error:', err));
            });
        }
    </script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* üîß –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            --bg-color: #0f0f23;
            --card-color: #1a1a2e;
            --text-color: #ffffff;
            --border-color: #2d3748;
            --accent-color: #667eea;
            --secondary-color: #764ba2;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-theme {
            --bg-color: #ffffff;
            --card-color: #f8f9fa;
            --text-color: #2d3748;
            --border-color: #e2e8f0;
            --accent-color: #667eea;
            --secondary-color: #764ba2;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-color);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        /* –í–∫–ª–∞–¥–∫–∏ (Tabs) */
        .tabs {
            display: flex;
            background: var(--card-color);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-weight: 600;
            font-size: 13px;
            border-radius: 8px;
            opacity: 0.7;
            transition: 0.3s;
            white-space: nowrap;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            opacity: 1;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* –§–æ—Ä–º—ã */
        .form-group { margin-bottom: 15px; }
        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--card-color);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-size: 16px;
            transition: 0.3s;
        }
        .form-control:focus { outline: none; border-color: var(--accent-color); }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary { background: var(--border-color); color: var(--text-color); box-shadow: none; }
        .btn-danger { background: #ff4757; margin-top: 20px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .item-card {
            background: var(--card-color);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .item-main { display: flex; gap: 12px; }
        .item-info { flex: 1; min-width: 0; }
        .item-title { font-weight: 700; font-size: 16px; margin-bottom: 5px; line-height: 1.3; }
        .item-meta { font-size: 13px; opacity: 0.7; margin-bottom: 5px; }
        
        /* –†–µ–π—Ç–∏–Ω–≥ */
        .rating { color: #FFD700; font-size: 18px; letter-spacing: 2px; }
        .rating-input span { cursor: pointer; color: var(--border-color); font-size: 24px; transition: 0.2s; }
        .rating-input span.active { color: #FFD700; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-container { height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent-color); transition: width 0.3s; }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .quick-progress { display: flex; gap: 5px; margin-top: 8px; overflow-x: auto; padding-bottom: 5px; }
        .qp-btn {
            padding: 6px 12px;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .status-chip {
            padding: 8px 16px;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            font-size: 13px;
            white-space: nowrap;
            transition: 0.3s;
        }
        .status-chip.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            padding: 15px;
            background: var(--card-color);
            border-left: 4px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 9999;
            transform: translateY(-150%);
            transition: transform 0.3s ease;
        }
        .notification.show { transform: translateY(0); }

        /* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading { text-align: center; padding: 40px; opacity: 0.6; }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* PWA –∫–Ω–æ–ø–∫–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        #pwa-install-row { display: none; }
    </style>
</head>
<body>

    <div id="notification" class="notification">
        <div style="font-weight:bold; margin-bottom:4px;" id="notif-title">Info</div>
        <div id="notif-msg">Message</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéå AniManga Tracker</h1>
            <p style="opacity: 0.7; font-size: 14px;">–¢–≤–æ–π –ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('anime')">üé¨ –ê–Ω–∏–º–µ</button>
            <button class="tab" onclick="switchTab('manga')">üìö –ú–∞–Ω–≥–∞</button>
            <button class="tab" onclick="switchTab('stats')">üìä –ò–Ω—Ñ–æ</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div id="anime" class="section active">
            <div class="item-card" style="border-style: dashed; text-align: center;">
                <h3 style="margin-bottom: 10px;">–î–æ–±–∞–≤–∏—Ç—å –ê–Ω–∏–º–µ</h3>
                <input type="text" id="animeInput" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ù–∞—Ä—É—Ç–æ)" style="margin-bottom: 10px;">
                <input type="number" id="animeTotalEp" class="form-control" placeholder="–í—Å–µ–≥–æ —Å–µ—Ä–∏–π (12)" style="margin-bottom: 10px;">
                <select id="animeStatusSelect" class="form-control" style="margin-bottom: 10px;">
                    <option value="watching">üëÄ –°–º–æ—Ç—Ä—é</option>
                    <option value="planned">üìÖ –í –ø–ª–∞–Ω–∞—Ö</option>
                    <option value="completed">‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
                    <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                </select>
                <button class="btn" onclick="addItem('anime')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div class="status-scroll" id="animeFilters"></div>
            <div id="animeList"><div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        </div>

        <div id="manga" class="section">
            <div class="item-card" style="border-style: dashed; text-align: center;">
                <h3 style="margin-bottom: 10px;">–î–æ–±–∞–≤–∏—Ç—å –ú–∞–Ω–≥—É</h3>
                <input type="text" id="mangaInput" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ë–µ—Ä—Å–µ—Ä–∫)" style="margin-bottom: 10px;">
                <input type="number" id="mangaTotalCh" class="form-control" placeholder="–í—Å–µ–≥–æ –≥–ª–∞–≤ (100)" style="margin-bottom: 10px;">
                <select id="mangaStatusSelect" class="form-control" style="margin-bottom: 10px;">
                    <option value="reading">üìñ –ß–∏—Ç–∞—é</option>
                    <option value="planned">üìÖ –í –ø–ª–∞–Ω–∞—Ö</option>
                    <option value="completed">‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</option>
                    <option value="dropped">‚ùå –ë—Ä–æ—à–µ–Ω–æ</option>
                </select>
                <button class="btn" onclick="addItem('manga')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div class="status-scroll" id="mangaFilters"></div>
            <div id="mangaList"><div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        </div>

        <div id="stats" class="section">
            <div class="item-card">
                <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <canvas id="statsChart" width="300" height="300"></canvas>
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                    <div style="background:var(--bg-color); padding:10px; border-radius:8px;">
                        <div style="font-size:24px; font-weight:bold; color:var(--accent-color)" id="statAnimeCount">0</div>
                        <div style="font-size:12px">–ê–Ω–∏–º–µ</div>
                    </div>
                    <div style="background:var(--bg-color); padding:10px; border-radius:8px;">
                        <div style="font-size:24px; font-weight:bold; color:var(--secondary-color)" id="statMangaCount">0</div>
                        <div style="font-size:12px">–ú–∞–Ω–≥–∞</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="item-card">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                
                <div class="settings-row">
                    <span>üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()" checked>
                </div>
                
                <div class="settings-row">
                    <span>üá∫üá∏ English Language</span>
                    <input type="checkbox" id="langToggle" onchange="toggleLang()">
                </div>

                <div class="settings-row" id="pwa-install-row">
                    <span>üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
                    <button class="qp-btn" onclick="installPWA()">–°–∫–∞—á–∞—Ç—å</button>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportData()">üì• –°–∫–∞—á–∞—Ç—å –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="margin-top:10px">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
                    <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                    
                    <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                    <button class="btn btn-secondary" onclick="window.location.reload()" style="margin-top: 20px; opacity: 0.5;">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å App</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        let tg = window.Telegram.WebApp;
        tg.expand();
        if (tg.ready) tg.ready();

        document.documentElement.style.setProperty('--bg-color', tg.backgroundColor || '#0f0f23');
        document.documentElement.style.setProperty('--card-color', tg.secondaryBackgroundColor || '#1a1a2e');
        document.documentElement.style.setProperty('--text-color', tg.textColor || '#ffffff');

        const DB_KEY = 'animanga_db_' + (tg.initDataUnsafe?.user?.id || 'local_user');
        let appData = { anime: [], manga: [], settings: { theme: 'dark', lang: 'ru' } };
        let currentFilter = { anime: 'all', manga: 'all' };

        const i18n = {
            ru: {
                anime: '–ê–Ω–∏–º–µ', manga: '–ú–∞–Ω–≥–∞', stats: '–ò–Ω—Ñ–æ', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                add: '–î–æ–±–∞–≤–∏—Ç—å', watch: '–°–º–æ—Ç—Ä—é', plan: '–í –ø–ª–∞–Ω–∞—Ö', done: '–ì–æ—Ç–æ–≤–æ', drop: '–ë—Ä–æ—à–µ–Ω–æ',
                ep: '—ç–ø.', ch: '–≥–ª.', empty: '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç', deleteConfirm: '–£–¥–∞–ª–∏—Ç—å?',
                saved: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', imported: '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'
            },
            en: {
                anime: 'Anime', manga: 'Manga', stats: 'Stats', settings: 'Settings',
                add: 'Add', watch: 'Watching', plan: 'Planned', done: 'Completed', drop: 'Dropped',
                ep: 'ep.', ch: 'ch.', empty: 'List is empty', deleteConfirm: 'Delete?',
                saved: 'Saved!', imported: 'Data imported'
            }
        };

        // --- –ó–ê–ü–£–°–ö ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAll();
            checkPWA();
        });

        // --- –§–£–ù–ö–¶–ò–ò ---
        function loadData() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) {
                try {
                    appData = JSON.parse(raw);
                    if (!appData.anime) appData.anime = [];
                    if (!appData.manga) appData.manga = [];
                    if (!appData.settings) appData.settings = { theme: 'dark', lang: 'ru' };
                } catch (e) { console.error(e); }
            }
            applySettings();
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
            renderStats();
        }

        function addItem(type) {
            const input = document.getElementById(type + 'Input');
            const totalInput = document.getElementById(type === 'anime' ? 'animeTotalEp' : 'mangaTotalCh');
            const statusSelect = document.getElementById(type + 'StatusSelect');
            
            const title = input.value.trim();
            if (!title) return showNotify('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

            appData[type].unshift({
                id: Date.now(),
                title: title,
                total: parseInt(totalInput.value) || 0,
                progress: 0,
                status: statusSelect.value,
                rating: 0
            });

            saveData();
            input.value = '';
            totalInput.value = '';
            renderList(type);
            showNotify('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ' + title);
        }

        function deleteItem(type, id) {
            if (confirm(getText('deleteConfirm'))) {
                appData[type] = appData[type].filter(i => i.id !== id);
                saveData();
                renderList(type);
            }
        }

        function updateProgress(type, id, change) {
            const item = appData[type].find(i => i.id === id);
            if (item) {
                item.progress = Math.max(0, item.progress + change);
                if (item.total > 0 && item.progress >= item.total && item.status !== 'completed') {
                    item.status = 'completed';
                    showNotify('üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!');
                }
                saveData();
                renderList(type);
            }
        }

        function updateRating(type, id, rating) {
            const item = appData[type].find(i => i.id === id);
            if (item) {
                item.rating = rating;
                saveData();
                renderList(type);
            }
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê ---
        function renderAll() {
            renderFilters('anime');
            renderFilters('manga');
            renderList('anime');
            renderList('manga');
            renderStats();
        }

        function renderFilters(type) {
            const container = document.getElementById(type + 'Filters');
            const statuses = ['all', 'watching', 'reading', 'planned', 'completed', 'dropped'];
            const validStatuses = statuses.filter(s => {
                if (type === 'anime' && s === 'reading') return false;
                if (type === 'manga' && s === 'watching') return false;
                return true;
            });

            container.innerHTML = validStatuses.map(status => {
                const label = getStatusLabel(status);
                const activeClass = currentFilter[type] === status ? 'active' : '';
                let count = status === 'all' ? appData[type].length : appData[type].filter(i => i.status === status).length;
                return `<div class="status-chip ${activeClass}" onclick="setFilter('${type}', '${status}')">${label} (${count})</div>`;
            }).join('');
        }

        function setFilter(type, status) {
            currentFilter[type] = status;
            renderFilters(type);
            renderList(type);
        }

        function renderList(type) {
            const listEl = document.getElementById(type + 'List');
            const items = appData[type].filter(item => currentFilter[type] === 'all' || item.status === currentFilter[type]);

            if (items.length === 0) {
                listEl.innerHTML = `<div style="text-align:center; opacity:0.5; padding:20px;">${getText('empty')}</div>`;
                return;
            }

            listEl.innerHTML = items.map(item => {
                const percent = item.total > 0 ? Math.min((item.progress / item.total) * 100, 100) : 0;
                const statusLabel = getStatusLabel(item.status);
                const unit = type === 'anime' ? getText('ep') : getText('ch');
                let starsHtml = '';
                for(let i=1; i<=5; i++) starsHtml += `<span class="${i <= item.rating ? 'active' : ''}" onclick="updateRating('${type}', ${item.id}, ${i})">‚òÖ</span>`;

                return `
                <div class="item-card">
                    <div class="item-main">
                        <div class="item-info">
                            <div class="item-title">${item.title}</div>
                            <div class="item-meta">${statusLabel} ‚Ä¢ ${item.progress} / ${item.total || '?'} ${unit}</div>
                            <div class="progress-container"><div class="progress-fill" style="width: ${percent}%"></div></div>
                        </div>
                        <div class="rating rating-input">${starsHtml}</div>
                    </div>
                    <div class="quick-progress">
                        <button class="qp-btn" onclick="updateProgress('${type}', ${item.id}, 1)">+1</button>
                        <button class="qp-btn" onclick="updateProgress('${type}', ${item.id}, 5)">+5</button>
                        <button class="qp-btn" onclick="updateProgress('${type}', ${item.id}, -1)">-1</button>
                        <button class="qp-btn" style="border-color:#ff4757; color:#ff4757" onclick="deleteItem('${type}', ${item.id})">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            document.getElementById('statAnimeCount').innerText = appData.anime.length;
            document.getElementById('statMangaCount').innerText = appData.manga.length;
            const ctx = document.getElementById('statsChart').getContext('2d');
            const s = { watch: 0, plan: 0, done: 0, drop: 0 };
            [...appData.anime, ...appData.manga].forEach(i => {
                if (i.status === 'watching' || i.status === 'reading') s.watch++;
                else if (i.status === 'planned') s.plan++;
                else if (i.status === 'completed') s.done++;
                else if (i.status === 'dropped') s.drop++;
            });

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [getText('watch'), getText('plan'), getText('done'), getText('drop')],
                    datasets: [{
                        data: [s.watch, s.plan, s.done, s.drop],
                        backgroundColor: ['#667eea', '#f6e58d', '#6ab04c', '#ff4757'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-color') } } } }
            });
        }

        // --- HELPERS ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            const idx = ['anime', 'manga', 'stats', 'settings'].indexOf(tabId);
            if(idx !== -1) document.querySelectorAll('.tab')[idx].classList.add('active');
        }

        function showNotify(msg) {
            const n = document.getElementById('notification');
            document.getElementById('notif-msg').innerText = msg;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        function getText(key) { return i18n[appData.settings.lang][key] || key; }
        function getStatusLabel(status) {
            const map = { 'all': '–í—Å–µ', 'watching': getText('watch'), 'reading': getText('watch'), 'planned': getText('plan'), 'completed': getText('done'), 'dropped': getText('drop') };
            return map[status] || status;
        }

        function applySettings() {
            const s = appData.settings;
            document.body.className = s.theme === 'light' ? 'light-theme' : '';
            document.getElementById('themeToggle').checked = s.theme === 'dark';
            document.getElementById('langToggle').checked = s.lang === 'en';
            const tabs = document.querySelectorAll('.tab');
            tabs[0].innerText = 'üé¨ ' + getText('anime');
            tabs[1].innerText = 'üìö ' + getText('manga');
            tabs[2].innerText = 'üìä ' + getText('stats');
            tabs[3].innerText = '‚öôÔ∏è ' + getText('settings');
            renderFilters('anime'); renderFilters('manga'); renderStats();
        }

        function toggleTheme() { appData.settings.theme = document.getElementById('themeToggle').checked ? 'dark' : 'light'; saveData(); applySettings(); }
        function toggleLang() { appData.settings.lang = document.getElementById('langToggle').checked ? 'en' : 'ru'; saveData(); applySettings(); }

        function exportData() {
            const blob = new Blob([JSON.stringify(appData)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "animanga_backup.json";
            document.body.appendChild(a); a.click();
            showNotify('üì• –§–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    appData = JSON.parse(e.target.result);
                    saveData(); applySettings(); renderAll();
                    showNotify('‚úÖ ' + getText('imported'));
                } catch(err) { showNotify('‚ùå –û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞'); }
            };
            reader.readAsText(file);
        }

        function clearData() {
            if(confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.removeItem(DB_KEY);
                appData = { anime: [], manga: [], settings: { theme: 'dark', lang: 'ru' } };
                saveData(); renderAll(); showNotify('üóëÔ∏è –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
            }
        }

        // --- PWA Logic ---
        let deferredPrompt;
        function checkPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('pwa-install-row').style.display = 'flex';
            });
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    document.getElementById('pwa-install-row').style.display = 'none';
                });
            } else {
                alert('–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ iPhone: –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" -> "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π".');
            }
        }
    </script>
</body>
</html>
